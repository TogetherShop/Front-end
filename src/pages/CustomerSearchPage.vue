<template>
  <div class="search-page bg-white position-relative">
    <!-- 상단바 -->
    <CustomerTopBar />
    
    <!-- 메인 콘텐츠 -->
    <main class="search-page__content">
      <!-- 제목 섹션 -->
      <div class="customer-search__header text-center">
        <h1 class="customer-search__title fw-bold text-dark mb-2">당신만을 위한<br>맞춤 장소 추천</h1>
        <p class="customer-search__subtitle">데이터 기반 인사이트로 완벽한 장소를 찾아보세요</p>
      </div>
      
      <!-- 검색바 -->
      <div class="customer-search__search-container px-4 mb-4">
        <div class="customer-search__search-bar bg-white rounded shadow-sm position-relative">
          <i class="material-symbols-outlined customer-search__search-icon">search</i>
          <input 
            type="text" 
            class="customer-search__search-input" 
            placeholder="매장명 검색"
            v-model="searchQuery"
            @input="handleSearchInput"
          >
          <div v-if="isSearching" class="customer-search__search-loading position-absolute end-0 top-50 translate-middle-y me-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">검색 중...</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 검색 결과 섹션 -->
      <div v-if="hasSearchResults" class="customer-search__results mx-3 mb-4">
        <div class="customer-search__results-list d-flex flex-column gap-3">
          <div 
            v-for="store in searchResults" 
            :key="store.businessId"
            class="customer-search__result-item"
          >
            <div class="customer-search__result-content">
              <div class="customer-search__result-image">
                <div 
                  class="customer-search__result-image-bg" 
                  :style="{ backgroundImage: store.image ? `url(${store.image})` : 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)' }"
                ></div>
              </div>
              <div class="customer-search__result-info">
                <div class="customer-search__result-header">
                  <h4 class="customer-search__result-name">{{ store.businessName }}</h4>
                  <span class="customer-search__result-status">{{ store.addressType || '오프라인' }}</span>
                  <div class="customer-search__result-rating" v-if="store.averageRating">
                    <i class="material-symbols-outlined customer-search__star-icon">star</i>
                    <span>{{ formatRating(store.averageRating) }}</span>
                  </div>
                </div>
                <span class="customer-search__result-category">{{ store.businessCategory }}</span>
                <div class="customer-search__result-address" v-if="store.address">
                  <i class="material-symbols-outlined">location_on</i>
                  <span>{{ store.address }}</span>
                </div>
              </div>
            </div>
            

          </div>
        </div>
      </div>

      <!-- 검색 결과 없음 메시지 -->
      <div v-if="searchQuery.trim() && !isSearching && !hasSearchResults" class="customer-search__no-results mx-3 mb-4 text-center py-5">
        <i class="material-symbols-outlined text-muted mb-3" style="font-size: 48px;">search_off</i>
        <h4 class="text-muted mb-2">검색 결과가 없습니다</h4>
        <p class="text-muted small">다른 검색어로 시도해보세요</p>
      </div>
      
      <!-- 맞춤추천 섹션 (검색 중이 아닐 때만 표시) -->
      <div v-if="!hasSearchResults" class="customer-search__hotplace bg-light-green rounded-3 mx-3 mb-4 p-4">
        <h2 class="customer-search__hotplace-title mb-2">20대가 선택하는 핫플레이스</h2>
        <p class="customer-search__hotplace-subtitle mb-3">또래들이 가장 많이 찾는 트렌디한 장소들</p>
        
        <!-- 로딩 상태 -->
        <div v-if="recommendedStoresLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">추천 매장 로딩 중...</span>
          </div>
        </div>
        
        <!-- 추천 매장 카드들 -->
        <div v-else class="customer-search__hotplace-cards d-flex gap-3 overflow-auto">
          <div 
            v-for="store in recommendedStores" 
            :key="store.id"
            class="customer-search__hotplace-card bg-light rounded-3 p-3 flex-shrink-0" 
          >
            <div class="customer-search__hotplace-card-image position-relative mb-3">
              <div 
                class="customer-search__hotplace-card-image-bg rounded-3" 
                :style="{ backgroundImage: store.image ? `url(${store.image})` : 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)' }"
              ></div>
              <div class="customer-search__hotplace-card-category position-absolute top-0 end-0 m-2">
                <span class="badge bg-white text-dark border">{{ store.businessCategory || '매장' }}</span>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="customer-search__hotplace-card-name fw-bold text-dark mb-0">{{ store.businessName }}</h3>
              <div class="d-flex align-items-center">
                <i class="material-symbols-outlined text-warning me-1 customer-search__hotplace-card-rating-icon">star</i>
                <span class="fw-semibold text-dark">{{ formatRating(store.averageRating) }}</span>
              </div>
            </div>
            <p class="customer-search__hotplace-card-description text-muted small mb-2">{{ store.description || '매장 설명이 없습니다.' }}</p>
            <div class="d-flex justify-content-between align-items-center">
              <div class="customer-search__hotplace-card-address d-flex align-items-center">
                <i class="material-symbols-outlined customer-search__hotplace-card-address-icon">location_on</i>
                <span class="text-muted small">{{ store.address || '주소 정보 없음' }}</span>
              </div>
              <span class="customer-search__hotplace-card-visitor-count">{{ store.visitCount || '0' }}명</span>
            </div>
          </div>

        </div>
      </div>
      
      <!-- 관련 매장 추천 섹션 (검색 중이 아닐 때만 표시) -->
      <div v-if="!hasSearchResults" class="customer-search__related bg-light-green rounded-3 mx-3 mb-5 p-4">
        <h2 class="customer-search__related-title mb-2">
          <span class="customer-search__related-title-highlight">{{ recentBusiness?.businessName || '매장' }}</span><span class="customer-search__related-title-normal">을<br>방문한 고객들이 자주 가는 곳</span>
        </h2>
        <p class="customer-search__related-subtitle text-muted small mb-3">유사한 취향을 가진 고객들의 선택</p>
        
        <!-- 로딩 상태 -->
        <div v-if="relatedStoresLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">관련 매장 로딩 중...</span>
          </div>
        </div>
        
        <!-- 관련 매장 카드들 -->
        <div v-else class="customer-search__related-cards d-flex gap-3 overflow-auto">
          <div 
            v-for="store in relatedStores" 
            :key="store.businessId"
            class="customer-search__related-card bg-light rounded-3 p-3 flex-shrink-0" 
          >
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="customer-search__related-card-name fw-bold text-dark mb-0">{{ store.businessName }}</h3>
              <span 
                class="badge customer-search__related-card-category bg-light-green text-primary"
              >{{ store.businessCategory || '매장' }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="customer-search__related-card-progress flex-grow-1 me-3">
                <div class="progress customer-search__related-card-progress-bar">
                  <div 
                    class="progress-bar customer-search__related-card-progress-fill bg-primary"
                    :style="{ width: `${(store.associationRate || 0) * 1240}%` }"
                  ></div>
                </div>
              </div>
              <span 
                class="fw-semibold customer-search__related-card-percentage text-primary"
              >{{ Math.round((store.associationRate || 0) * 1240) }}%</span>
            </div>
          </div>

        </div>
      </div>
    </main>
    
    <!-- 하단 네비게이션 -->
    <CustomerBottomNavigation />
  </div>
</template>

<script>
import { ref, computed, onMounted } from 'vue'
import CustomerTopBar from '@/components/CustomerTopBar.vue'
import CustomerBottomNavigation from '@/components/CustomerBottomNavigation.vue'
import { getRecommendedStores, getRelatedStores, searchStores } from '@/api/customer-search.js'

export default {
  name: 'SearchPage',
  components: {
    CustomerTopBar,
    CustomerBottomNavigation
  },
  setup() {
    // 반응형 데이터
    const searchQuery = ref('')
    const isSearching = ref(false)
    const recommendedStores = ref([])
    const recommendedStoresLoading = ref(false)
    const relatedStores = ref([])
    const recentBusiness = ref(null)
    const relatedStoresLoading = ref(false)

    // 더미 데이터 - RecommendedBusinessDTO 형식
    const dummyRecommendedStores = [
      {
        id: 1,
        businessName: '카페 모먼트',
        description: '감성적인 인테리어와 맛있는 원두로 유명한 카페',
        address: '서울특별시 강남구 테헤란로 123',
        visitCount: 1240,
        averageRating: 4.8
      },
      {
        id: 2,
        businessName: '브런치 하우스',
        description: '건강한 재료로 만든 브런치 전문점',
        address: '서울특별시 강남구 압구정로 456',
        visitCount: 890,
        averageRating: 4.6
      },
      {
        id: 3,
        businessName: '커피빈 강남점',
        description: '프리미엄 원두로 만든 특별한 커피',
        address: '서울특별시 강남구 선릉로 789',
        visitCount: 1560,
        averageRating: 4.5
      },
      {
        id: 4,
        businessName: '베이커리 스위트',
        description: '수제 빵과 디저트로 유명한 베이커리',
        address: '서울특별시 강남구 도곡로 321',
        visitCount: 980,
        averageRating: 4.7
      }
    ]

    // 평점 포맷팅 함수
    const formatRating = (rating) => {
      if (!rating) return '0.0'
      return parseFloat(rating).toFixed(1)
    }

    // 추천 매장 데이터 로드
    const loadRecommendedStores = async () => {
      recommendedStoresLoading.value = true
      try {
        console.log('추천 매장 API 호출 시작...')
        const response = await getRecommendedStores({ limit: 10 })
        console.log('추천 매장 API 응답:', response)
        
        if (response && Array.isArray(response)) {
          // RecommendedBusinessDTO 배열을 직접 받는 경우
          recommendedStores.value = response.map(store => ({
            id: store.id,
            businessName: store.businessName,
            description: store.description,
            address: store.address,
            visitCount: store.visitCount,
            averageRating: store.averageRating
          }))
        } else if (response && response.data && Array.isArray(response.data)) {
          // 응답이 { data: [...] } 형태인 경우
          recommendedStores.value = response.data.map(store => ({
            id: store.id,
            businessName: store.businessName,
            description: store.description,
            address: store.address,
            visitCount: store.visitCount,
            averageRating: store.averageRating
          }))
        } else {
          console.warn('추천 매장 API 응답 형식이 예상과 다릅니다:', response)
          recommendedStores.value = []
        }
        
        console.log('추천 매장 데이터 설정 완료:', recommendedStores.value)
      } catch (error) {
        console.error('추천 매장 데이터 로드 실패:', error)
        
        // 403 오류인 경우 특별 처리
        if (error.response?.status === 403) {
          console.warn('403 Forbidden - 추천 매장 API 권한이 없거나 구현되지 않았을 수 있습니다.')
          recommendedStores.value = []
        } else {
          // 다른 에러의 경우 더미 데이터로 fallback
          recommendedStores.value = dummyRecommendedStores
        }
      } finally {
        recommendedStoresLoading.value = false
      }
    }

    // 더미 데이터 - RelatedBusinessDTO 형식
    const dummyRecentBusiness = {
      businessId: 1,
      businessName: '스타벅스 강남점',
      businessCategory: '카페',
      associationRate: 1.0
    }

    const dummyRelatedStores = [
      {
        businessId: 2,
        businessName: '투썸플레이스',
        businessCategory: '카페',
        associationRate: 0.85
      },
      {
        businessId: 3,
        businessName: '베이글베이글',
        businessCategory: '카페',
        associationRate: 0.72
      },
      {
        businessId: 4,
        businessName: '샐러디',
        businessCategory: '샐러드',
        associationRate: 0.68
      },
      {
        businessId: 5,
        businessName: '서브웨이',
        businessCategory: '샌드위치',
        associationRate: 0.55
      },
      {
        businessId: 6,
        businessName: '맥도날드',
        businessCategory: '패스트푸드',
        associationRate: 0.45
      }
    ]

    // 관련 매장 데이터 로드
    const loadRelatedStores = async () => {
      relatedStoresLoading.value = true
      try {
        console.log('관련 매장 API 호출 시작...')
        const response = await getRelatedStores()
        console.log('관련 매장 API 응답:', response)
        
        if (response && response.recentBusiness && response.relatedBusiness) {
          // CustomerVisitPatternResponseDTO 형식으로 받는 경우
          recentBusiness.value = {
            businessId: response.recentBusiness.businessId,
            businessName: response.recentBusiness.businessName,
            businessCategory: response.recentBusiness.businessCategory,
            associationRate: response.recentBusiness.associationRate
          }
          
          relatedStores.value = response.relatedBusiness.map(store => ({
            businessId: store.businessId,
            businessName: store.businessName,
            businessCategory: store.businessCategory,
            associationRate: store.associationRate
          }))
        } else if (response && response.data) {
          // 응답이 { data: {...} } 형태인 경우
          recentBusiness.value = {
            businessId: response.data.recentBusiness.businessId,
            businessName: response.data.recentBusiness.businessName,
            businessCategory: response.data.recentBusiness.businessCategory,
            associationRate: response.data.recentBusiness.associationRate
          }
          
          relatedStores.value = response.data.relatedBusiness.map(store => ({
            businessId: store.businessId,
            businessName: store.businessName,
            businessCategory: store.businessCategory,
            associationRate: store.associationRate
          }))
        } else {
          console.warn('관련 매장 API 응답 형식이 예상과 다릅니다:', response)
          recentBusiness.value = null
          relatedStores.value = []
        }
        
        console.log('관련 매장 데이터 설정 완료:', { recentBusiness: recentBusiness.value, relatedStores: relatedStores.value })
      } catch (error) {
        console.error('관련 매장 데이터 로드 실패:', error)
        
        // 403 오류인 경우 특별 처리
        if (error.response?.status === 403) {
          console.warn('403 Forbidden - 관련 매장 API 권한이 없거나 구현되지 않았을 수 있습니다.')
          recentBusiness.value = null
          relatedStores.value = []
        } else {
          // 다른 에러의 경우 더미 데이터로 fallback
          recentBusiness.value = dummyRecentBusiness
          relatedStores.value = dummyRelatedStores
        }
      } finally {
        relatedStoresLoading.value = false
      }
    }

    // 전체 매장 데이터는 더 이상 사용하지 않음 (API 검색으로 대체)

    const popularSearchTerms = ref([
      '스타벅스',
      '카페',
      '맥도날드',
      '맘스터치',
      '투썸플레이스'
    ])

    // 검색 결과 (검색 시 필터링된 데이터)
    const searchResults = ref([])

    // 검색 결과가 있는지 확인하는 computed
    const hasSearchResults = computed(() => searchResults.value.length > 0)

    // 매장 검색 (BusinessSearchDTO)
    const searchStoresHandler = async () => {
      if (!searchQuery.value.trim()) {
        searchResults.value = []
        return
      }

      isSearching.value = true
      
      try {
        console.log('매장 검색 API 호출 시작...', { query: searchQuery.value })
        const response = await searchStores({ 
          query: searchQuery.value,
          limit: 20 
        })
        console.log('매장 검색 API 응답:', response)
        
        if (response && Array.isArray(response)) {
          // BusinessSearchDTO 배열을 직접 받는 경우
          searchResults.value = response.map(store => ({
            businessId: store.businessId,
            businessName: store.businessName,
            businessCategory: store.businessCategory,
            address: store.address,
            averageRating: store.averageRating,
            addressType: store.addressType
          }))
        } else if (response && response.data && Array.isArray(response.data)) {
          // 응답이 { data: [...] } 형태인 경우
          searchResults.value = response.data.map(store => ({
            businessId: store.businessId,
            businessName: store.businessName,
            businessCategory: store.businessCategory,
            address: store.address,
            averageRating: store.averageRating,
            addressType: store.addressType
          }))
        } else {
          console.warn('매장 검색 API 응답 형식이 예상과 다릅니다:', response)
          searchResults.value = []
        }
        
        console.log('매장 검색 결과 설정 완료:', searchResults.value)
      } catch (error) {
        console.error('매장 검색 실패:', error)
        
        // 403 오류인 경우 특별 처리
        if (error.response?.status === 403) {
          console.warn('403 Forbidden - 매장 검색 API 권한이 없거나 구현되지 않았을 수 있습니다.')
          searchResults.value = []
        } else {
          // 다른 에러의 경우 빈 결과로 처리
          searchResults.value = []
        }
      } finally {
        isSearching.value = false
      }
    }

    // 검색어 변경 감지 (디바운싱)
    const debouncedSearch = computed(() => {
      let timeout
      return () => {
        clearTimeout(timeout)
        timeout = setTimeout(() => {
          searchStoresHandler()
        }, 300)
      }
    })

    // 검색어 입력 핸들러
    const handleSearchInput = () => {
      debouncedSearch.value()
    }

    // 컴포넌트 마운트 시 추천 매장과 관련 매장 로드
    onMounted(() => {
      loadRecommendedStores()
      loadRelatedStores()
    })

    return {
      // 반응형 데이터
      searchQuery,
      recommendedStores,
      recommendedStoresLoading,
      relatedStores,
      recentBusiness,
      relatedStoresLoading,
      popularSearchTerms,
      searchResults,
      isSearching,
      hasSearchResults,
      
      // 메서드
      handleSearchInput,
      searchStoresHandler,
      formatRating
    }
  }
}
</script>

<style>
@import '../styles/customer-search-page.css';
</style>
